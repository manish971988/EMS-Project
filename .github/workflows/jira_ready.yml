name: Jira Ready â†’ GitHub Issue

on:
  repository_dispatch:
    types: [jira_ready_for_dev]

permissions:
  issues: write
  contents: read

jobs:
  create_or_update_issue:
    runs-on: ubuntu-latest

    env:
      # From repository_dispatch payload (keep the Jira rule tiny: only jiraKey/jiraUrl)
      JIRA_KEY: ${{ github.event.client_payload.jiraKey }}
      JIRA_URL: ${{ github.event.client_payload.jiraUrl }}

    steps:
      - uses: actions/checkout@v4

      - name: Fetch Jira fields (summary, description HTML, AC, labels)
        id: jira
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_KEY: ${{ env.JIRA_KEY }}
        run: |
          set -e

          # 1) Validate secrets
          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_USER_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "Missing Jira secrets. Please set JIRA_BASE_URL, JIRA_USER_EMAIL, JIRA_API_TOKEN."
            exit 1
          fi

          # 2) Clean base URL and build Basic auth without newline
          BASE="${JIRA_BASE_URL%/}"
          AUTH=$(printf "%s:%s" "$JIRA_USER_EMAIL" "$JIRA_API_TOKEN" | base64 | tr -d '\n')

          # 3) Build fields list
          FIELDS="summary,labels,description"
        

          # 4) Call Jira (capture HTTP code + body)
          set +e
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o issue.json \
            --fail-with-body \
            -H "Authorization: Basic $AUTH" \
            -H "Accept: application/json" \
            "$BASE/rest/api/3/issue/${JIRA_KEY}?fields=${FIELDS}&expand=renderedFields")
          CURL_RC=$?
          set -e

          if [ $CURL_RC -ne 0 ] || [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Jira API request failed. HTTP=$HTTP_CODE"
            echo "Response body:"
            cat issue.json || true
            exit 1
          fi

          # 5) Extract fields with jq
          TITLE=$(jq -r '.fields.summary // ""' issue.json)

          # Prefer rendered HTML; fall back to raw (ADF/string)
          DESCRIPTION_HTML=$(jq -r '.renderedFields.description // ""' issue.json)
          if [ -z "$DESCRIPTION_HTML" ] || [ "$DESCRIPTION_HTML" = "null" ]; then
            DESCRIPTION_HTML=$(jq -r '.fields.description // ""' issue.json)
          fi
     

          LABELS=$(jq -r '[.fields.labels[]] | join(", ")' issue.json)
          if [ "$LABELS" = "null" ]; then LABELS=""; fi

          # 6) Emit outputs
          {
            echo "title<<EOF"
            echo "$TITLE"
            echo "EOF"
            echo "description_html<<EOF"
            echo "$DESCRIPTION_HTML"
            echo "EOF"
            echo "ac<<EOF"
            echo "$AC"
            echo "EOF"
            echo "labels=$LABELS"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare Issue body
        id: prep
        run: |
          cat > body.md << 'EOF'
          **Jira**: ${{ env.JIRA_KEY }}  
          Link: ${{ env.JIRA_URL }}

          ## Story
          ${{ steps.jira.outputs.title }}

          ## Description
          <!-- Rendered from Jira (may include HTML) -->
          ${{ steps.jira.outputs.description_html }}

          ## Acceptance Criteria
          ${{ steps.jira.outputs.ac }}

          ---
          _Labels from Jira_: `${{ steps.jira.outputs.labels }}`
          EOF

      - name: Create or update Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Build title with fallback if Jira title is empty
          BASE_TITLE="${{ steps.jira.outputs.title }}"
          if [ -z "$BASE_TITLE" ]; then BASE_TITLE="Work for ${{ env.JIRA_KEY }}"; fi
          TITLE_LINE="${{ env.JIRA_KEY }}: ${BASE_TITLE}"

          NUM=$(gh issue list --search "$TITLE_LINE in:title" --state open --json number --jq '.[0].number')

          # Build --label flags from Jira labels (comma-separated)
          LABEL_ARGS="--label from-jira --label ready-for-dev"
          if [ -n "${{ steps.jira.outputs.labels }}" ]; then
            IFS=',' read -ra LBL <<< "${{ steps.jira.outputs.labels }}"
            for l in "${LBL[@]}"; do
              l=$(echo "$l" | xargs)
              [ -n "$l" ] && LABEL_ARGS="$LABEL_ARGS --label \"$l\""
            done
          fi

          if [ -n "$NUM" ]; then
            echo "Issue exists #$NUM, adding comment"
            gh issue comment "$NUM" -F body.md
          else
            echo "Creating new Issue"
            # shellcheck disable=SC2086
            eval gh issue create --title \"${TITLE_LINE}\" -F body.md $LABEL_ARGS
          fi
