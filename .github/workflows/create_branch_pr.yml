name: Create Branch & Draft PR (Scaffold)

on:
  workflow_dispatch:
    inputs:
      jiraKey:
        description: "Jira issue key (e.g. EMS-123)"
        required: true
        type: string
      branchName:
        description: "Custom branch name (optional, defaults to feature/<jiraKey>)"
        required: false
        type: string
      scaffoldPath:
        description: "Optional subfolder for scaffolding (e.g. app/Http/Controllers)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  scaffold:
    runs-on: ubuntu-latest
    steps:
      - name: Generate branch name
        id: vars
        run: |
          BRANCH="${{ inputs.branchName }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="feature/${{ inputs.jiraKey }}"
          fi
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Branch to create: $BRANCH"

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create scaffold files
        run: |
          set -e
          BRANCH="${{ steps.vars.outputs.branch }}"
          git checkout -b "$BRANCH"

          # Optional scaffold path
          SCAFFOLD_PATH="${{ inputs.scaffoldPath }}"
          if [ -z "$SCAFFOLD_PATH" ]; then
            SCAFFOLD_PATH="scaffolds/${{ inputs.jiraKey }}"
          fi

          mkdir -p "$SCAFFOLD_PATH"

          cat > "$SCAFFOLD_PATH/README.md" <<EOF
          # ${SCAFFOLD_PATH}
          This branch was auto-created for Jira **${{ inputs.jiraKey }}**.
          Use this scaffold to begin development for ${SCAFFOLD_PATH}.

          Generated on: $(date)
          EOF

          echo "Created scaffold in $SCAFFOLD_PATH"
          git add "$SCAFFOLD_PATH"
          git commit -m "chore(${{ inputs.jiraKey }}): create scaffold at $SCAFFOLD_PATH"
          git push origin "$BRANCH"

      - name: Create draft PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          BRANCH="${{ steps.vars.outputs.branch }}"

          echo "Creating draft PR for branch: $BRANCH"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "${{ inputs.jiraKey }}: New scaffold branch" \
            --body "This PR was auto-generated from the **Create Branch & Draft PR** workflow.  
            
            - Jira key: **${{ inputs.jiraKey }}**  
            - Branch: \`$BRANCH\`  
            - Scaffold path: \`${{ inputs.scaffoldPath || format('scaffolds/%s', inputs.jiraKey) }}\`  
            
            Next steps:  
            1. Assign this PR to **Copilotâ€™s coding agent** or a developer.  
            2. Implement your feature and push commits.  
            3. Convert to a regular PR when ready for review." \
            --draft

      - name: Confirm PR created
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr list --state open --search "${{ inputs.jiraKey }} in:title"
