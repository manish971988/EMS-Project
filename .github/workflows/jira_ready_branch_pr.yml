name: Jira Ready → Controlled Branch + Draft PR + Auto Copilot

on:
  repository_dispatch:
    types: [jira_ready_for_dev]

permissions:
  contents: write         # create branch, push commit
  pull-requests: write    # create PR, comment on PR
  issues: write           # optional, if you also touch issues
  actions: read

jobs:
  branch_pr_copilot:
    runs-on: ubuntu-latest

    env:
      JIRA_KEY: ${{ github.event.client_payload.jiraKey }}
      JIRA_URL: ${{ github.event.client_payload.jiraUrl }}
      TITLE: ${{ github.event.client_payload.title }}
      DESCRIPTION: ${{ github.event.client_payload.description }}
      ACCEPTANCE_CRITERIA: ${{ github.event.client_payload.acceptanceCriteria }}
      RAW_LABELS: ${{ github.event.client_payload.labels }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute branch name (feat/<KEY>-<kebab-title>)
        id: naming
        run: |
          SLUG=$(printf "%s" "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g' | cut -c1-40)
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "branch=feat/${JIRA_KEY}-${SLUG}" >> $GITHUB_OUTPUT

      - name: Resolve default branch
        id: default
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEFAULT=$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name)
          echo "name=$DEFAULT" >> $GITHUB_OUTPUT

      # ✅ FIXED: create/use the branch LOCALLY, then push (avoids 'pathspec did not match' errors)
      - name: Create/checkout branch locally, empty commit, push
        id: seed_branch
        run: |
          set -e
          BRANCH="${{ steps.naming.outputs.branch }}"
          DEFAULT="${{ steps.default.outputs.name }}"

          git fetch --prune origin

          # idempotent: if remote branch exists, track it; else create from default
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git fetch origin "$BRANCH":"refs/remotes/origin/$BRANCH"
            git checkout -B "$BRANCH" "refs/remotes/origin/$BRANCH"
          else
            git checkout "origin/$DEFAULT"
            git switch -c "$BRANCH"
            git config user.name "automation-bot"
            git config user.email "automation-bot@users.noreply.github.com"
            git commit --allow-empty -m "${JIRA_KEY} bootstrap branch"
            git push --set-upstream origin "$BRANCH"
          fi

      - name: Prepare PR body
        run: |
          cat > body.md << 'EOF'
          **Jira**: ${JIRA_KEY}
          ${JIRA_URL}

          **Story**
          ${TITLE}

          **Description**
          ${DESCRIPTION}

          **Acceptance Criteria**
          ${ACCEPTANCE_CRITERIA}

          ---
          **Working Instructions (for Copilot & humans)**
          - Work **only** on branch: `${{ steps.naming.outputs.branch }}`
          - Keep PR tied to this Jira ticket: ${JIRA_KEY}
          - Follow acceptance criteria and existing test conventions.
          EOF

      - name: Create or reuse Draft PR (head = feature branch, base = default)
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEFAULT="${{ steps.default.outputs.name }}"
          HEAD="${{ steps.naming.outputs.branch }}"
          TITLE_LINE="${JIRA_KEY}: ${TITLE}"

          # reuse existing open PR from this branch if present
          EXISTING=$(gh pr list --state open --head "$HEAD" --json url --jq '.[0].url')
          if [ -n "$EXISTING" ]; then
            echo "url=$EXISTING" >> $GITHUB_OUTPUT
          else
            PR_URL=$(gh pr create \
              --title "$TITLE_LINE" \
              --body-file body.md \
              --base "$DEFAULT" \
              --head "$HEAD" \
              --draft)
            echo "url=$PR_URL" >> $GITHUB_OUTPUT
          fi

      - name: Auto-start Copilot on this PR (mention @copilot)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ steps.pr.outputs.url }}" -b "@copilot Please implement Jira ${JIRA_KEY} **on this PR and branch only**:
          - Branch: \`${{ steps.naming.outputs.branch }}\`
          - Jira: ${JIRA_URL}
          - Title: ${TITLE}

          **Acceptance Criteria**
          ${ACCEPTANCE_CRITERIA}

          Notes:
          - Do not create new branches or PRs.
          - Commit directly to \`${{ steps.naming.outputs.branch }}\`.
          - Keep changes minimal and adhere to project conventions and tests."
